# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ Convertik

> –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ: 2023-09-18 (–±–æ–ª–µ–µ 2 –ª–µ—Ç –Ω–∞–∑–∞–¥)
> –ü—Ä–æ–±–ª–µ–º–∞: iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä

## üìä –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

- ‚úÖ –í –±–∞–∑–µ –µ—Å—Ç—å 5 —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π (2023-09-18)
- ‚ùå –ù–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π –Ω–µ—Ç (0 –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞)
- ‚ùå –ú–µ—Ç—Ä–∏–∫–∏ –≤—Å–µ —Ä–∞–≤–Ω—ã 0
- ‚úÖ Endpoint `/stats/metrics` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ endpoint `/stats`

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
cd /opt/convertik
./test_stats_endpoint.sh
```

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
1. –û—Ç–ø—Ä–∞–≤–∏—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –Ω–∞ `/api/v1/stats`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å –≤ –ë–î
3. –ü–æ–∫–∞–∂–µ—Ç –¥–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –°–æ–±—ã—Ç–∏–µ –¥–æ–ª–∂–Ω–æ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –ë–î.

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ API

```bash
# –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤
docker logs convertik-api --tail=100

# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å–æ stats
docker logs convertik-api | grep -i "stats\|event\|error" | tail -50

# –õ–æ–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
docker logs convertik-api --since 1h | grep -i "stats"
```

**–ß—Ç–æ –∏—Å–∫–∞—Ç—å:**
- –û—à–∏–±–∫–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏–π
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö device_id
- –ó–∞–ø—Ä–æ—Å—ã –∫ `/stats` endpoint

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

#### 3.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ URL API

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL:

```swift
// –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
let apiURL = "https://api.convertik.ponravilos.ru/api/v1/stats"
```

#### 3.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –∫–æ–¥–µ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
- –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ª–∏ —Å–æ–±—ã—Ç–∏—è –≤–æ–æ–±—â–µ?
- –ï—Å—Ç—å –ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫?
- –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏?

#### 3.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è (–æ—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏ —Ç.–¥.)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –ø–æ—è–≤–∏–ª–∏—Å—å –ª–∏ —Å–æ–±—ã—Ç–∏—è –≤ –ë–î:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
docker exec -e PGPASSWORD="$POSTGRES_PASSWORD" convertik-db psql -U convertik -d convertik -c "SELECT * FROM usage_events ORDER BY created_at DESC LIMIT 5;"
```

## üõ†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

–ï—Å–ª–∏ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏:**
   - –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
   - –ù–µ—Ç –ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (firewall, VPN)
   - –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω SSL/TLS

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API:**
   - –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ URL
   - –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ –º–µ—Ç–æ–¥ (POST)
   - –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö

### –†–µ—à–µ–Ω–∏–µ 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π:

```swift
// –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
func sendEvent(_ event: AnalyticsEvent) {
    print("üìä –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è: \(event.name)")

    // ... –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ ...

    URLSession.shared.dataTask(with: request) { data, response, error in
        if let error = error {
            print("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏—è: \(error)")
        } else if let httpResponse = response as? HTTPURLResponse {
            print("‚úÖ –°–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: HTTP \(httpResponse.statusCode)")
        }
    }.resume()
}
```

### –†–µ—à–µ–Ω–∏–µ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ CORS –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å CORS –∏–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Caddy (–ø—Ä–æ–∫—Å–∏)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Caddy:

```bash
# –õ–æ–≥–∏ Caddy
docker logs caddy | grep convertik
```

### –†–µ—à–µ–Ω–∏–µ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å curl

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:

```bash
# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
curl -X POST https://api.convertik.ponravilos.ru/api/v1/stats \
  -H "Content-Type: application/json" \
  -d '{
    "events": [
      {
        "device_id": "550e8400-e29b-41d4-a716-446655440000",
        "name": "app_open",
        "ts": '$(date +%s)',
        "params": {}
      }
    ]
  }'
```

## üìã –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] Endpoint `/stats` —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ç–µ—Å—Ç —á–µ—Ä–µ–∑ curl)
- [ ] –°–æ–±—ã—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ SQL)
- [ ] iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL
- [ ] iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤)
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö API
- [ ] –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (firewall, CORS)
- [ ] SSL/TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤–∞–ª–∏–¥–µ–Ω

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç endpoint** (`./test_stats_endpoint.sh`)
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ API** –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–∏ –æ–Ω–æ —Å–æ–±—ã—Ç–∏—è
4. **–î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** - –Ω–µ—Ç –ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

## üìû –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ —Å–æ–±—ã—Ç–∏—è –≤—Å–µ –µ—â–µ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è:

1. –°–æ–±–µ—Ä–∏—Ç–µ –ª–æ–≥–∏:
   ```bash
   docker logs convertik-api --tail=500 > api_logs.txt
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
   - URL API
   - –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∏–ª–∏ –ø—Ä–æ–∫—Å–∏ (Charles, mitmproxy)


