

# API.md  
> üåê REST‚ÄëAPI –±–µ–∫—ç–Ω–¥–∞ ¬´–ö–æ–Ω–≤–µ—Ä—Ç–∏–∫¬ª (–≤–µ—Ä—Å–∏—è¬†v1)  
> –í—Å–µ –æ—Ç–≤–µ—Ç—ã ‚Äî `application/json; charset=utf‚Äë8`  
> –ë–∞–∑–æ–≤—ã–π URL –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ: `https://api.convertik.app/api/v1`

## –°–≤–æ–¥–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

| –≠–Ω–¥–ø–æ–∏–Ω—Ç                 | –ú–µ—Ç–æ–¥ | –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                             |
|--------------------------|-------|-------------|----------------------------------------|
| `/rates`                 | GET   | ‚Äî           | –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç                  |
| `/stats`                 | POST  | ‚Äî           | –ü—Ä–∏—ë–º batched‚Äë—Å–æ–±—ã—Ç–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏        |
| `/iap/verify`            | POST  | ‚Äî           | –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ IAP (StoreKit2)    |
| `/push/register`         | POST  | ‚Äî           | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è push‚Äë—Ç–æ–∫–µ–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞     |
| `/admin/push/send`       | POST  | `X-Admin`   | –û—Ç–ø—Ä–∞–≤–∫–∞ push‚Äë—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å–µ–≥–º–µ–Ω—Ç—É |
| `/health`                | GET   | ‚Äî           | Liveness / readiness probe            |

> üîí  –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã `/admin/*` –∑–∞—â–∏—â–µ–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–æ–º `X-Admin-Token: <secret>`  
> (—Ç–æ–∫–µ–Ω –∑–∞–¥–∞—ë—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `ADMIN_TOKEN` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ).

---

## 1. GET¬†`/rates`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ö—ç—à –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ –∏ –¥–∞—Ç—É –∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

### –ó–∞–ø—Ä–æ—Å  
```
GET /api/v1/rates
```

### –û—Ç–≤–µ—Ç¬†`200¬†OK`
```json
{
  "updated_at": "2025-07-31T10:00:00Z",
  "base": "RUB",
  "rates": {
    "USD": 0.01119,
    "EUR": 0.01007,
    "GBP": 0.00870
  }
}
```

### –ö–æ–¥—ã –æ—à–∏–±–æ–∫  
| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ                             |
|-----|--------------------------------------|
| 503 | –ö—É—Ä—Å—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã (–Ω–µ—Ç —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö) |

---

## 2. POST¬†`/stats`

–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –º–∞—Å—Å–∏–≤ —Å–æ–±—ã—Ç–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (‚â§‚ÄØ50 –æ–±—ä–µ–∫—Ç–æ–≤ –∑–∞¬†–∑–∞–ø—Ä–æ—Å).  
–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–µ–º `device_id` (UUID v4), –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–º –≤ –∫–∞–∂–¥–æ–º —Å–æ–±—ã—Ç–∏–∏.

### –ó–∞–ø—Ä–æ—Å  
`Content‚ÄëType: application/json`
```json
[
  {
    "name": "app_open",
    "ts": 1690800000,
    "device_id": "2cb4e0d4‚Äëb3cf‚Äë46e2‚Äë942c‚Äë0e7d2fc8dcdd"
  },
  {
    "name": "conversion",
    "device_id": "2cb4e0d4‚Äëb3cf‚Äë46e2‚Äë942c‚Äë0e7d2fc8dcdd",
    "ts": 1690800010,
    "params": { "from": "USD", "to": "EUR", "amount": 150 }
  }
]
```

### –û—Ç–≤–µ—Ç¬†`202¬†Accepted`
```json
{ "accepted": 2 }
```

### –ö–æ–¥—ã –æ—à–∏–±–æ–∫  
| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ                           |
|-----|------------------------------------|
| 400 | JSON‚Äë—Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞ |
| 429 | –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ (rate‚Äëlimit)  |

---

## 3. POST¬†`/iap/verify`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É Premium –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ App¬†Store¬†Server¬†API.

### –ó–∞–ø—Ä–æ—Å  
`Content‚ÄëType: application/json`
```json
{
  "receipt_data": "<base64-receipt>",
  "device_id": "2cb4e0d4‚Äëb3cf‚Äë46e2‚Äë942c‚Äë0e7d2fc8dcdd",
  "app_account_token": "c1d4‚Ä¶",  // optional, UUID
  "sandbox": false                // true –¥–ª—è TestFlight / Sandbox
}
```

### –û—Ç–≤–µ—Ç—ã  
*`200¬†OK`* ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞  
```json
{
  "premium": true,
  "expires_at": "2025-09-01T12:00:00Z",
  "original_tx_id": "360001234567890",
  "plan": "convertik_premium_month"
}
```

*`402¬†Payment Required`* ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –∏—Å—Ç–µ–∫–ª–∞  
```json
{ "premium": false, "reason": "expired" }
```

*`400`* ‚Äî –Ω–µ–≤–µ—Ä–Ω—ã–π base64 / re√ßeipt –ø–æ–≤—Ä–µ–∂–¥—ë–Ω.  
*`500`* ‚Äî –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å App¬†Store¬†Server¬†API.

---

## 4. POST¬†`/push/register`

–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç push‚Äë—Ç–æ–∫–µ–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (APNs) –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —Ä–∞—Å—Å—ã–ª–æ–∫.

### –ó–∞–ø—Ä–æ—Å  
```json
{
  "device_id": "2cb4e0d4‚Äëb3cf‚Äë46e2‚Äë942c‚Äë0e7d2fc8dcdd",
  "token": "3f39da672b6e3d7bd4f‚Ä¶",   // hex‚Äë—Å—Ç—Ä–æ–∫–∞
  "platform": "ios",                // ios | android
  "locale": "ru-RU",
  "is_premium": false,
  "app_version": "1.0.1"
}
```

### –û—Ç–≤–µ—Ç¬†`201¬†Created`
```json
{ "registered": true }
```

---

## 5. POST¬†`/admin/push/send`  üîí

> –¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Admin-Token`.

–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç push‚Äë—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å–µ–≥–º–µ–Ω—Ç—É.

### –ó–∞–ø—Ä–æ—Å  
```json
{
  "title": "–ö—É—Ä—Å—ã –æ–±–Ω–æ–≤–∏–ª–∏—Å—å!",
  "body": "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≥–æ–¥–Ω—ã–π –∫—É—Ä—Å EUR –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.",
  "segment": {
    "is_premium": false,
    "last_seen_days_gt": 3
  }
}
```

### –û—Ç–≤–µ—Ç¬†`202¬†Accepted`
```json
{ "queued": 4821, "platforms": { "ios": 4300, "android": 521 } }
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã `segment`
| –ü–æ–ª–µ                | –¢–∏–ø   | –ó–Ω–∞—á–µ–Ω–∏–µ                                   |
|---------------------|-------|--------------------------------------------|
| `is_premium`        | bool  | true / false / null (=–Ω–µ –≤–∞–∂–Ω–æ)            |
| `locale_in`         | array | ["ru", "en"]                               |
| `last_seen_days_gt` | int   | > N –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ `app_open`              |
| `currency_in`       | array | ["USD","EUR"] ‚Äî –≤–∞–ª—é—Ç–∞ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |

---

## 6. GET¬†`/health`

–ü—Ä–æ–±–∞ –∂–∏–≤–æ—Å—Ç–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Kubernetes / –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥).

* `200 OK`¬†‚Äî —Å–µ—Ä–≤–∏—Å –≥–æ—Ç–æ–≤  
* `500`¬†¬†¬†¬†‚Äî –ø—Ä–æ–±–ª–µ–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î)

---

## –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –æ—à–∏–±–æ–∫

```jsonc
{
  "error": {
    "code": 400,
    "message": "Invalid JSON",
    "details": { "field": "receipt_data" }
  }
}
```

| –ü–æ–ª–µ     | –û–ø–∏—Å–∞–Ω–∏–µ                            |
|----------|-------------------------------------|
| `code`   | HTTP‚Äë–∫–æ–¥                            |
| `message`| –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ           |
| `details`| –î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –¥–µ–±–∞–≥–∞ (–æ–ø—Ü.)   |

---

## –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

* **URI‚Äë–≤–µ—Ä—Å–∏—è** (`/api/v1`) ‚Äî –ø—Ä–∏ –º–∞–∂–æ—Ä–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤.  
* –ú–∏–Ω–æ—Ä–Ω—ã–µ –ø–æ–ª—è –º–æ–≥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏ (–¥–æ–±–∞–≤–ª–µ–Ω—ã –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).

---

## CORS

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é CORS –≤—ã–∫–ª—é—á–µ–Ω (API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞—Ç–∏–≤–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º).  
–î–ª—è —Ü–µ–ª–µ–π –æ—Ç–ª–∞–¥–∫–∏ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫:
```
Access-Control-Allow-Origin: *
```
–Ω–∞ staging‚Äë–æ–∫—Ä—É–∂–µ–Ω–∏–∏.

---